<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.2.xsd"
    logicalFilePath="descriptors/database/jbilling-upgrade-4.31.xml">

    <changeSet context = "base" id = "JBSPC-154: Outbound Interchange table added new column user_id and last_retry_datetime" author = "Ashwinkumar Patra">
        <validCheckSum>7:57d4dc1e43e6db6b3c7c4fb08bd46cde</validCheckSum>
        <comment>Adding Foreign Key Constraint on user_id</comment>

        <createIndex tableName = "outbound_interchange"
                     indexName = "outbound_interchange_fk_base_user">
            <column name = "user_id" />
        </createIndex>

        <addForeignKeyConstraint constraintName         = "outbound_interchange_fk_base_user"
                                 baseTableName          = "outbound_interchange"
                                 referencedTableName    = "base_user"
                                 baseColumnNames        = "user_id"
                                 referencedColumnNames  = "id" />
    </changeSet>

    <changeSet context="base" id="JBFC-928 : Added fc specific entries for payment methgod - JCB" author="Swapnil Patil">
        <insert tableName = "payment_method">
            <column name = "id"  valueNumeric = "11" />
        </insert>

        <insert tableName="international_description">
            <column name = "foreign_id"    valueComputed = "11"/>
            <column name = "table_id"      valueNumeric  = "35"/>
            <column name = "psudo_column"  value         = "description"/>
            <column name = "language_id"   valueNumeric  = "1"/>
            <column name = "content"       value         = "JCB"/>
        </insert>
    </changeSet>

    <changeSet context = "base" id = "JBFC-910 added sub reports to DCR" author = "Mahesh Shivarkar">
        <insert tableName = "report_parameter">
            <column name = "id"        valueComputed = "(SELECT COALESCE(MAX(rp.id), 1)+1 FROM report_parameter rp)"/>
            <column name = "report_id" valueComputed = "(SELECT id FROM report r WHERE r.name = 'data_consistency_checks')"/>
            <column name = "dtype"     value         = "boolean"/>
            <column name = "name"      value         = "asset_conflict_report"/>
        </insert>
        <insert tableName = "report_parameter">
            <column name = "id"        valueComputed = "(SELECT COALESCE(MAX(rp.id), 1)+1 FROM report_parameter rp)"/>
            <column name = "report_id" valueComputed = "(SELECT id FROM report r WHERE r.name = 'data_consistency_checks')"/>
            <column name = "dtype"     value         = "boolean"/>
            <column name = "name"      value         = "multiple_plans_on_same_order"/>
        </insert>
        <insert tableName = "report_parameter">
            <column name = "id"        valueComputed = "(SELECT COALESCE(MAX(rp.id), 1)+1 FROM report_parameter rp)"/>
            <column name = "report_id" valueComputed = "(SELECT id FROM report r WHERE r.name = 'data_consistency_checks')"/>
            <column name = "dtype"     value         = "boolean"/>
            <column name = "name"      value         = "usage_order_quantity_mismatches_customer_usage_pool_quantity"/>
        </insert>
    </changeSet>

    <changeSet context = "base" id = "JB-3509 Disable the caching for invoice id" author = "Krunal Bhavsar">
        <update tableName = "jbilling_seqs">
            <column name = "next_id" valueComputed = "(SELECT COALESCE(MAX(invoice.id), 1)+1 FROM invoice invoice)"/>
            <where>name = 'invoice'</where>
        </update>
    </changeSet>

    <changeSet  context = "test" id = "RE-4.32.2-customer-usage-pool-test-case" author = "Ashok Kale">
       <comment>To fix customer usage pool related failing test-cases added required fields data into customer_usage_pool_map table.</comment>
       <update tableName="customer_usage_pool_map">
            <column name="cycle_start_date" valueDate="1970-01-01 00:00:00.000"/>
            <column name="order_id"      valueNumeric="1055"/>
            <where>id=1</where>
        </update>
    </changeSet>
</databaseChangeLog>
