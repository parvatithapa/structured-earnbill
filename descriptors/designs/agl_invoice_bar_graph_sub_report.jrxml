<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="agl_invoice_bar_graph_sub_report" language="groovy" pageWidth="285" pageHeight="260" columnWidth="285" leftMargin="0" rightMargin="0" topMargin="0" bottomMargin="0" uuid="815c334c-2816-4b5b-ba35-efd7026a099a">
	<property name="ireport.zoom" value="1.0"/>
	<property name="ireport.x" value="0"/>
	<property name="ireport.y" value="0"/>
	<parameter name="invoice_user_id" class="java.lang.Integer"/>
	<parameter name="currency_symbol" class="java.lang.String"/>
	<parameter name="invoice_id" class="java.lang.Integer"/>
	<parameter name="SUBREPORT_DIR" class="java.lang.String" isForPrompting="false">
		<defaultValueExpression><![CDATA[""]]></defaultValueExpression>
	</parameter>
	<parameter name="BASE_DIR" class="java.lang.String"/>
	<queryString>
		<![CDATA[(SELECT s.month, s.int_month, s.int_year, sum(s.total) AS total FROM
(
SELECT CONCAT(SUBSTRING(TO_CHAR(i_outer.create_datetime::date, 'Month'),1,3),'-',TO_CHAR(i_outer.create_datetime::date,'YY')) AS month,
EXTRACT(MONTH FROM i_outer.create_datetime) AS int_month,
EXTRACT(YEAR FROM i_outer.create_datetime) AS int_year,
CASE WHEN
(
	SELECT mfv.decimal_value
	FROM invoice_meta_field_map im
	INNER JOIN meta_field_value mfv ON mfv.id = im.meta_field_value_id
	INNER JOIN meta_field_name mfn ON mfn.id = mfv.meta_field_name_id
	WHERE mfv.id = im.meta_field_value_id
	AND mfn.name = 'New Charges'
	AND im.invoice_id = i_outer.id
) IS NOT NULL
THEN
(
	SELECT mfv.decimal_value
	FROM invoice_meta_field_map im
	INNER JOIN meta_field_value mfv ON mfv.id = im.meta_field_value_id
	INNER JOIN meta_field_name mfn ON mfn.id = mfv.meta_field_name_id
	WHERE mfv.id = im.meta_field_value_id
	AND mfn.name = 'New Charges'
	AND im.invoice_id = i_outer.id
)
ELSE
(
	SUM(il_outer.amount)+
	(
		SELECT COALESCE(SUM(il.amount),0)
		FROM invoice_line il
		INNER JOIN invoice i ON i.id = il.invoice_id
		AND i.create_datetime BETWEEN
		(
		    SELECT create_datetime - INTERVAL '1 months'
		    FROM invoice
		    WHERE id = i_outer.id
		)
		AND
		(
		    SELECT create_datetime
		    FROM invoice
		    WHERE id = i_outer.id
		)
		AND i.id IN
		(
			SELECT id
			FROM   invoice
			WHERE  user_id = $P{invoice_user_id}
			AND    id IN ( SELECT unnest(adjustmentInvoices($P{invoice_user_id})))
		)
	)
)
END AS total
FROM invoice_line il_outer
INNER JOIN invoice i_outer ON i_outer.id = il_outer.invoice_id
WHERE i_outer.create_datetime BETWEEN
(
	SELECT DATE_TRUNC('MONTH',create_datetime - INTERVAL '2 months')::DATE
	FROM invoice
	WHERE id = $P{invoice_id}
) AND
(
	SELECT create_datetime
	FROM invoice
	WHERE id = $P{invoice_id}
)
AND i_outer.user_id = $P{invoice_user_id}
AND il_outer.type_id != 3
-- Exclude Adjustment invoices
AND i_outer.id NOT IN
(
	SELECT id
	FROM   invoice
	WHERE  user_id = $P{invoice_user_id}
	AND    id IN ( SELECT unnest(adjustmentInvoices($P{invoice_user_id})))
)
GROUP BY 1,2,3, i_outer.id
ORDER BY int_year DESC, int_month DESC
) s
GROUP BY 1,2,3
ORDER BY int_year DESC, int_month DESC)
LIMIT 3;]]>
	</queryString>
	<field name="month" class="java.lang.String"/>
	<field name="int_month" class="java.lang.Double"/>
	<field name="int_year" class="java.lang.Double"/>
	<field name="total" class="java.math.BigDecimal"/>
	<variable name="all_total" class="java.math.BigDecimal" calculation="Sum">
		<variableExpression><![CDATA[$F{total}]]></variableExpression>
	</variable>
	<variable name="max_total" class="java.math.BigDecimal" calculation="Highest">
		<variableExpression><![CDATA[$F{total}]]></variableExpression>
	</variable>
	<variable name="total_SUM" class="java.math.BigDecimal" calculation="Sum">
		<variableExpression><![CDATA[$F{total}]]></variableExpression>
	</variable>
	<group name="BarGraphMonth">
		<groupExpression><![CDATA[$F{month}]]></groupExpression>
		<groupHeader>
			<band height="23">
				<textField>
					<reportElement x="0" y="-5" width="100" height="13" uuid="3b43d854-5654-401d-a7b3-0819a24dc0e1"/>
					<textElement>
						<font fontName="BrauerNeue-Regular" pdfEncoding="Identity-H" isPdfEmbedded="true"/>
					</textElement>
					<textFieldExpression><![CDATA[$F{month}]]></textFieldExpression>
				</textField>
				<subreport>
					<reportElement x="-13" y="4" width="235" height="5" uuid="170e9e69-f96f-41fb-a3ef-b4afcd3f448d"/>
					<subreportParameter name="total">
						<subreportParameterExpression><![CDATA[$F{total}]]></subreportParameterExpression>
					</subreportParameter>
					<subreportParameter name="SUBREPORT_DIR">
						<subreportParameterExpression><![CDATA[$P{SUBREPORT_DIR}]]></subreportParameterExpression>
					</subreportParameter>
					<subreportParameter name="int_month">
						<subreportParameterExpression><![CDATA[$F{int_month}]]></subreportParameterExpression>
					</subreportParameter>
					<subreportParameter name="BASE_DIR">
						<subreportParameterExpression><![CDATA[$P{BASE_DIR}]]></subreportParameterExpression>
					</subreportParameter>
					<subreportParameter name="invoice_user_id">
						<subreportParameterExpression><![CDATA[$P{invoice_user_id}]]></subreportParameterExpression>
					</subreportParameter>
					<subreportParameter name="int_year">
						<subreportParameterExpression><![CDATA[$F{int_year}]]></subreportParameterExpression>
					</subreportParameter>
					<subreportParameter name="month">
						<subreportParameterExpression><![CDATA[$F{month}]]></subreportParameterExpression>
					</subreportParameter>
					<subreportParameter name="currency_symbol">
						<subreportParameterExpression><![CDATA[$P{currency_symbol}]]></subreportParameterExpression>
					</subreportParameter>
					<subreportParameter name="invoice_id">
						<subreportParameterExpression><![CDATA[$P{invoice_id}]]></subreportParameterExpression>
					</subreportParameter>
					<connectionExpression><![CDATA[$P{REPORT_CONNECTION}]]></connectionExpression>
					<subreportExpression><![CDATA[$P{SUBREPORT_DIR} + "agl_invoice_bar_graph_sub_sub_report.jasper"]]></subreportExpression>
				</subreport>
				<textField>
					<reportElement x="235" y="10" width="50" height="13" uuid="4911245c-e951-458b-833f-be82def5f54c"/>
					<textElement textAlignment="Right" verticalAlignment="Bottom">
						<font fontName="BrauerNeue-Regular" isBold="true" pdfEncoding="Identity-H" isPdfEmbedded="true"/>
					</textElement>
					<textFieldExpression><![CDATA[$P{currency_symbol}+''+
($F{total} <= 0 ? '0.00' : (new java.text.DecimalFormat("#,##0.00").format($F{total}.setScale(2, BigDecimal.ROUND_HALF_UP))))]]></textFieldExpression>
				</textField>
			</band>
		</groupHeader>
	</group>
</jasperReport>
